<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Calendrix AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080f0f;--s1:#0d1818;--s2:#111f1f;--s3:#172626;
  --border:rgba(32,200,160,0.12);--border2:rgba(255,255,255,0.06);
  --teal:#0fd4a4;--teal2:#07b890;--teal-dim:rgba(15,212,164,0.12);
  --amber:#f5c842;--red:#f87171;
  --text:#dff0ee;--muted:#4d7a74;--r:14px;
}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden}
.bg-mesh{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 700px 500px at 0% 0%,rgba(15,212,164,0.06) 0%,transparent 60%),radial-gradient(ellipse 500px 400px at 100% 100%,rgba(7,184,144,0.05) 0%,transparent 60%)}

header{position:relative;z-index:10;padding:18px 32px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(8,15,15,0.85);backdrop-filter:blur(16px)}
.brand{display:flex;align-items:center;gap:12px}
.brand-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--teal),var(--teal2));display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:0 0 20px rgba(15,212,164,0.3)}
.brand-name{font-family:'Instrument Serif',serif;font-size:21px}
.brand-name span{color:var(--teal)}
.status-pill{display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:100px;background:var(--s2);border:1px solid var(--border);font-size:12px;color:var(--muted)}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--muted)}
.status-dot.live{background:var(--teal);box-shadow:0 0 6px var(--teal);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}

main{flex:1;display:grid;grid-template-columns:1fr 320px;position:relative;z-index:1;height:calc(100vh - 61px);overflow:hidden}

.chat-area{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}
.chat-topbar{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:var(--s1);flex-shrink:0}
.bot-avatar{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--teal),#0a9b7a);display:flex;align-items:center;justify-content:center;font-size:21px;flex-shrink:0;box-shadow:0 0 18px rgba(15,212,164,0.25);position:relative}
.bot-avatar::after{content:'';position:absolute;bottom:2px;right:2px;width:10px;height:10px;border-radius:50%;background:var(--teal);border:2px solid var(--s1)}
.bot-info h3{font-family:'Instrument Serif',serif;font-size:17px}
.bot-info p{font-size:12px;color:var(--muted);margin-top:2px}

#messages{flex:1;overflow-y:auto;padding:24px 20px;display:flex;flex-direction:column;gap:18px;scroll-behavior:smooth}
#messages::-webkit-scrollbar{width:3px}
#messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

.msg{display:flex;gap:10px;animation:msgIn .3s ease}
.msg.user{flex-direction:row-reverse}
@keyframes msgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.msg-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:2px}
.msg-av.bot{background:linear-gradient(135deg,var(--teal),#0a9b7a)}
.msg-av.user{background:var(--s3);border:1px solid var(--border2)}
.msg-body{max-width:72%}
.bubble{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.65}
.msg.bot .bubble{background:var(--s2);border:1px solid var(--border);border-top-left-radius:4px}
.msg.user .bubble{background:linear-gradient(135deg,var(--teal),var(--teal2));color:#041a18;font-weight:500;border-top-right-radius:4px}
.msg-time{font-size:10px;color:var(--muted);margin-top:5px;padding:0 4px}
.msg.user .msg-time{text-align:right}

.typing-dots{display:flex;gap:5px;align-items:center;padding:14px 16px}
.typing-dots span{width:7px;height:7px;border-radius:50%;background:var(--teal);opacity:.6;animation:dot 1.2s infinite}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-7px)}}

.booking-card-msg{background:var(--s2);border:1px solid var(--teal);border-radius:14px;overflow:hidden;box-shadow:0 0 24px rgba(15,212,164,0.08)}
.bc-header{background:linear-gradient(135deg,rgba(15,212,164,0.15),rgba(7,184,144,0.08));padding:14px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.bc-header h4{font-family:'Instrument Serif',serif;font-size:16px;color:var(--teal)}
.bc-body{padding:16px 18px;display:flex;flex-direction:column;gap:10px}
.bc-row{display:flex;align-items:center;gap:10px;font-size:13px}
.bc-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0;color:var(--teal)}
.bc-label{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.05em;min-width:55px}
.bc-val{font-weight:600;color:var(--text)}
.bc-actions{padding:14px 18px;border-top:1px solid var(--border);display:flex;gap:10px}
.bc-btn{flex:1;padding:11px;border-radius:10px;border:none;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.bc-btn.confirm{background:linear-gradient(135deg,var(--teal),var(--teal2));color:#041a18}
.bc-btn.confirm:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(15,212,164,0.3)}
.bc-btn.confirm:disabled{opacity:.5;cursor:not-allowed;transform:none}
.bc-btn.edit{background:var(--s3);color:var(--muted);border:1px solid var(--border2)}
.bc-btn.edit:hover{color:var(--text);border-color:var(--border)}

.success-card-msg{background:var(--s2);border:1px solid var(--teal);border-radius:14px;overflow:hidden;box-shadow:0 0 32px rgba(15,212,164,0.12)}
.sc-top{background:linear-gradient(135deg,rgba(15,212,164,0.18),rgba(7,184,144,0.08));padding:20px;text-align:center}
.sc-check{width:56px;height:56px;border-radius:50%;background:rgba(15,212,164,0.2);display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 12px;border:2px solid rgba(15,212,164,0.4)}
.sc-top h4{font-family:'Instrument Serif',serif;font-size:19px;color:var(--teal);margin-bottom:4px}
.sc-top p{font-size:13px;color:var(--muted)}
.sc-details{padding:16px 20px;display:flex;flex-direction:column;gap:9px}
.sc-row{display:flex;align-items:center;gap:10px;font-size:13px}
.sc-links{padding:14px 20px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px}
.link-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:10px;font-size:13px;font-weight:600;text-decoration:none;transition:all .2s;border:none;cursor:pointer;font-family:'Outfit',sans-serif;width:100%}
.link-btn.primary{background:linear-gradient(135deg,var(--teal),var(--teal2));color:#041a18}
.link-btn.primary:hover{opacity:.9;transform:translateY(-1px)}
.link-btn.secondary{background:var(--s3);color:var(--text);border:1px solid var(--border2)}
.link-btn.secondary:hover{border-color:var(--teal);color:var(--teal)}
.link-btn.copy-lnk{background:transparent;color:var(--muted);border:1px dashed var(--border)}
.link-btn.copy-lnk:hover{border-color:var(--teal);color:var(--teal)}
.sc-new{margin:14px 20px;display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:10px;background:var(--s3);border:1px solid var(--border2);color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.sc-new:hover{color:var(--text);border-color:var(--border)}

.input-area{padding:16px 20px 20px;border-top:1px solid var(--border);background:var(--s1);flex-shrink:0}
.input-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:10px}
#text-input{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;color:var(--text);font-family:'Outfit',sans-serif;font-size:14px;resize:none;outline:none;min-height:46px;max-height:120px;transition:border-color .2s}
#text-input:focus{border-color:var(--teal)}
#text-input::placeholder{color:var(--muted)}
.btn-send{width:46px;height:46px;padding:0;border:none;border-radius:12px;background:linear-gradient(135deg,var(--teal),var(--teal2));color:#041a18;font-size:18px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-weight:600}
.btn-send:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(15,212,164,0.3)}
#mic-btn{width:46px;height:46px;padding:0;border:1px solid var(--border);border-radius:12px;background:var(--s2);color:var(--muted);font-size:18px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
#mic-btn:hover{border-color:var(--teal);color:var(--teal)}
#mic-btn.recording{background:var(--red);border-color:var(--red);color:#fff;font-size:16px;animation:recPulse 1s infinite}
@keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(248,113,113,.5)}50%{box-shadow:0 0 0 8px rgba(248,113,113,0)}}
.quick-chips{display:flex;gap:7px;flex-wrap:wrap}
.chip{padding:5px 12px;border-radius:100px;background:var(--s2);border:1px solid var(--border2);font-size:12px;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap}
.chip:hover{border-color:var(--teal);color:var(--teal)}

.sidebar{display:flex;flex-direction:column;background:var(--s1);overflow-y:auto}
.sidebar::-webkit-scrollbar{width:3px}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.sb-section{padding:18px;border-bottom:1px solid var(--border)}
.sb-title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;font-weight:600}

.steps{display:flex;flex-direction:column;gap:10px}
.step{display:flex;align-items:center;gap:12px}
.step-dot{width:28px;height:28px;border-radius:50%;flex-shrink:0;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);font-weight:600;transition:all .3s}
.step.active .step-dot{border-color:var(--teal);background:var(--teal-dim);color:var(--teal)}
.step.done .step-dot{border-color:var(--teal);background:var(--teal);color:#041a18}
.step-lbl{font-size:13px;color:var(--muted);transition:color .3s}
.step.active .step-lbl{color:var(--text);font-weight:500}
.step.done .step-lbl{color:var(--teal)}

.conn-row{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-radius:9px;background:var(--s2);border:1px solid var(--border2);font-size:12px;margin-bottom:7px}
.conn-row:last-child{margin-bottom:0}
.conn-label{color:var(--muted)}
.conn-ok{color:var(--teal);font-weight:600}
.conn-no{color:var(--amber);font-weight:600}

.booking-item{padding:12px;border-radius:10px;background:var(--s2);border:1px solid var(--border2);margin-bottom:8px;transition:border-color .2s}
.booking-item:hover{border-color:var(--border)}
.bi-title{font-size:13px;font-weight:600;margin-bottom:3px}
.bi-meta{font-size:11px;color:var(--muted);line-height:1.6}
.bi-link{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--teal);text-decoration:none;margin-top:4px}
.bi-link:hover{text-decoration:underline}

.tip{padding:10px 12px;border-radius:8px;background:var(--s2);border:1px solid var(--border2);font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:7px}
.tip:last-child{margin-bottom:0}
.tip strong{color:var(--text)}

#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--s2);border:1px solid var(--teal);color:var(--teal);padding:10px 22px;border-radius:100px;font-size:13px;font-weight:600;transition:transform .3s ease;z-index:1000;white-space:nowrap}
#toast.show{transform:translateX(-50%) translateY(0)}

@media(max-width:768px){main{grid-template-columns:1fr}.sidebar{display:none}}
</style>
</head>
<body>
<div class="bg-mesh"></div>

<header>
  <div class="brand">
    <div class="brand-icon">C</div>
    <div class="brand-name">Calendrix <span>AI</span></div>
  </div>
  <div class="status-pill">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-text">Connecting...</span>
  </div>
</header>

<main>
<div class="chat-area">
  <div class="chat-topbar">
    <div class="bot-avatar">A</div>
    <div class="bot-info">
      <h3>Calendrix AI</h3>
      <p>Smart Scheduling Assistant</p>
    </div>
  </div>
  <div id="messages"></div>
  <div class="input-area">
    <div class="input-row">
      <textarea id="text-input" rows="1" placeholder="Type a message or tap the mic to speak..."
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button id="mic-btn" onclick="toggleMic()" title="Click to record voice"><i class="fas fa-microphone"></i></button>
      <button class="btn-send" onclick="sendText()"><i class="fas fa-arrow-right"></i></button>
    </div>
    <div class="quick-chips">
      <div class="chip" onclick="qs('My name is Touseef')">Name</div>
      <div class="chip" onclick="qs('Tomorrow')">Tomorrow</div>
      <div class="chip" onclick="qs('Next Monday')">Next Monday</div>
      <div class="chip" onclick="qs('4 PM to 6 PM')">4 PM - 6 PM</div>
      <div class="chip" onclick="qs('10:30 AM to 11:30 AM')">10:30 - 11:30</div>
      <div class="chip" onclick="qs('Team standup')">Standup</div>
      <div class="chip" onclick="qs('Yes, create the event!')">Confirm</div>
    </div>
  </div>
</div>

<div class="sidebar">
  <div class="sb-section">
    <div class="sb-title">Booking Progress</div>
    <div class="steps">
      <div class="step active" id="stp-name"><div class="step-dot">1</div><div class="step-lbl">Your name</div></div>
      <div class="step" id="stp-date"><div class="step-dot">2</div><div class="step-lbl">Preferred date</div></div>
      <div class="step" id="stp-time"><div class="step-dot">3</div><div class="step-lbl">Time range</div></div>
      <div class="step" id="stp-title"><div class="step-dot">4</div><div class="step-lbl">Meeting title</div></div>
      <div class="step" id="stp-book"><div class="step-dot">5</div><div class="step-lbl">Confirm & book</div></div>
    </div>
  </div>

  <div class="sb-section">
    <div class="sb-title">Connections</div>
    <div class="conn-row"><span class="conn-label">OpenAI GPT-4o</span><span id="conn-openai" class="conn-no">Checking</span></div>
    <div class="conn-row"><span class="conn-label">Voice (Whisper)</span><span id="conn-voice" class="conn-no">Checking</span></div>
    <div class="conn-row"><span class="conn-label">Google Calendar</span><span id="conn-cal" class="conn-no">Checking</span></div>
  </div>

  <div class="sb-section">
    <div class="sb-title">Tips</div>
    <div class="tip"><strong>Voice:</strong> Click mic, speak naturally, tap to stop</div>
    <div class="tip"><strong>Dates:</strong> "tomorrow", "next Friday", "March 15"</div>
    <div class="tip"><strong>Times:</strong> "4 PM to 6 PM", "4:00-6:00", "16:00-18:00"</div>
  </div>

  <div class="sb-section">
    <div class="sb-title">Recent Bookings</div>
    <div id="recent-list"><div style="font-size:13px;color:var(--muted)">No bookings yet.</div></div>
  </div>
</div>
</main>

<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
let convStep=0, currentBooking=null, pendingCard=null;
let isRecording=false, mediaRecorder=null, audioChunks=[];
let isSpeaking=false;
const STEPS=['stp-name','stp-date','stp-time','stp-title','stp-book'];

document.addEventListener('DOMContentLoaded',async()=>{
  await checkStatus();
  await startConv();
  loadRecent();
});

async function checkStatus(){
  try{
    const d=await api('/api/status');
    const dot=ge('status-dot'),txt=ge('status-text');
    const oai=ge('conn-openai'),vox=ge('conn-voice'),cal=ge('conn-cal');
    if(d.openai){
      dot.classList.add('live');txt.textContent='AI Connected';
      oai.textContent='Connected';oai.className='conn-ok';
      vox.textContent='Ready';vox.className='conn-ok';
    } else {
      txt.textContent='Demo Mode';
      oai.textContent='No Key';vox.textContent='No Key';
    }
    if(d.google_calendar){cal.textContent='Connected';cal.className='conn-ok';}
    else{cal.textContent='Not set';}
  }catch(e){ge('status-text').textContent='Offline';}
}

async function startConv(){
  try{const d=await api('/api/start','POST',{});botMsg(d.message);speak(d.message);}
  catch(e){botMsg("Hello! I'm Calendrix AI. What's your name?");}
}

async function sendText(){
  const inp=ge('text-input');
  const txt=inp.value.trim();
  if(!txt) return;
  inp.value='';inp.style.height='auto';
  await doChat(txt);
}

function qs(t){ge('text-input').value=t;sendText();}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendText();}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}

async function doChat(text){
  userMsg(text);stepForward();showTyping();
  try{
    const d=await api('/api/chat','POST',{message:text});
    hideTyping();
    const show=d.clean_message||d.message||'';
    botMsg(show);speak(show);
    if(d.booking_data){currentBooking=d.booking_data;showBookingCard(d.booking_data);setSteps(5);}
  }catch(e){hideTyping();botMsg('Something went wrong — please try again.');}
}

async function toggleMic(){if(isRecording)stopMic();else await startMic();}

async function startMic(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
    mediaRecorder=new MediaRecorder(stream,{mimeType:mime});
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
    mediaRecorder.onstop=sendVoice;
    mediaRecorder.start(250);
    isRecording=true;
    const b=ge('mic-btn');b.classList.add('recording');
    toast('Recording...');
  }catch(e){toast('Mic access denied');}
}

function stopMic(){
  if(mediaRecorder&&isRecording){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    isRecording=false;
    const b=ge('mic-btn');b.classList.remove('recording');
  }
}

async function sendVoice(){
  if(!audioChunks.length) return;
  const blob=new Blob(audioChunks,{type:'audio/webm'});
  if(blob.size<500){toast('Recording too short, try again');return;}
  const fd=new FormData();
  fd.append('audio',blob,'recording.webm');
  showTyping();stepForward();
  try{
    const r=await fetch('/api/voice',{method:'POST',body:fd});
    const d=await r.json();hideTyping();
    if(d.error){toast('Error: '+d.error);return;}
    if(d.transcript)userMsg('Voice: '+d.transcript);
    const show=d.clean_message||d.message||'';
    if(show){botMsg(show);speak(show);}
    if(d.booking_data){currentBooking=d.booking_data;showBookingCard(d.booking_data);setSteps(5);}
  }catch(e){hideTyping();toast('Voice failed');}
}

async function speak(text){
  if(!text||isSpeaking) return;
  try{
    isSpeaking=true;
    const r=await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(!r.ok){isSpeaking=false;return;}
    const blob=await r.blob();
    const url=URL.createObjectURL(blob);
    const a=new Audio(url);
    a.onended=()=>{isSpeaking=false;URL.revokeObjectURL(url);};
    a.onerror=()=>{isSpeaking=false;};
    a.play();
  }catch{isSpeaking=false;}
}

function showBookingCard(b){
  const msgs=ge('messages');
  const d=fmtDate(b.date);
  const t=fmtTimeRange(b.start_time, b.end_time);
  const wrap=document.createElement('div');
  wrap.className='msg bot';
  wrap.innerHTML=`
    <div class="msg-av bot">A</div>
    <div class="msg-body" style="max-width:88%">
      <div class="booking-card-msg">
        <div class="bc-header">
          <span style="font-size:20px">✓</span>
          <h4>Ready to Book!</h4>
        </div>
        <div class="bc-body">
          <div class="bc-row"><span class="bc-icon"><i class="fas fa-user"></i></span><span class="bc-label">Name</span><span class="bc-val">${x(b.name)}</span></div>
          <div class="bc-row"><span class="bc-icon"><i class="fas fa-heading"></i></span><span class="bc-label">Title</span><span class="bc-val">${x(b.title)}</span></div>
          <div class="bc-row"><span class="bc-icon"><i class="fas fa-calendar"></i></span><span class="bc-label">Date</span><span class="bc-val">${d}</span></div>
          <div class="bc-row"><span class="bc-icon"><i class="fas fa-clock"></i></span><span class="bc-label">Time</span><span class="bc-val">${t}</span></div>
        </div>
        <div class="bc-actions">
          <button class="bc-btn edit" onclick="startNew()">Change</button>
          <button class="bc-btn confirm" id="confirm-btn" onclick="doConfirm(this)">Create Event</button>
        </div>
      </div>
      <div class="msg-time">${nowStr()}</div>
    </div>`;
  pendingCard=wrap;
  msgs.appendChild(wrap);
  msgs.scrollTop=msgs.scrollHeight;
}

async function doConfirm(btn){
  if(!currentBooking) return;
  btn.disabled=true;btn.textContent='Creating...';
  try{
    const d=await api('/api/confirm','POST',{booking:currentBooking});
    if(pendingCard){pendingCard.remove();pendingCard=null;}
    if(d.success){
      showSuccessCard(d);
      const s=d.summary;
      botMsg(`Done! "${s.title}" is booked for ${s.datetime}. Your Google Calendar has been updated!`);
      setSteps(6);loadRecent();
    } else {
      btn.disabled=false;btn.textContent='Create Event';
      toast('Failed — check your Google Calendar configuration');
    }
  }catch(e){
    btn.disabled=false;btn.textContent='Create Event';
    toast('Error: '+e.message);
  }
}

function showSuccessCard(d){
  const msgs=ge('messages');
  const s=d.summary;
  const realLink=d.event_link&&d.event_link.startsWith('http')&&!d.event_link.includes('demo_');
  const wrap=document.createElement('div');
  wrap.className='msg bot';
  wrap.innerHTML=`
    <div class="msg-av bot">A</div>
    <div class="msg-body" style="max-width:88%">
      <div class="success-card-msg">
        <div class="sc-top">
          <div class="sc-check">✓</div>
          <h4>Event Created!</h4>
          <p>Successfully added to Google Calendar</p>
        </div>
        <div class="sc-details">
          <div class="sc-row"><span style="font-size:16px"><i class="fas fa-heading"></i></span><span style="margin-left:8px;font-weight:600;font-size:14px">${x(s.title)}</span></div>
          <div class="sc-row"><span style="font-size:16px"><i class="fas fa-user"></i></span><span style="margin-left:8px;color:var(--muted);font-size:13px">${x(s.name)}</span></div>
          <div class="sc-row"><span style="font-size:16px"><i class="fas fa-calendar"></i></span><span style="margin-left:8px;color:var(--teal);font-weight:600;font-size:13px">${x(s.datetime)}</span></div>
        </div>
        <div class="sc-links">
          ${realLink?`<a href="${d.event_link}" target="_blank" class="link-btn primary"><i class="fas fa-calendar"></i> Open in Google Calendar</a>`:''}
          ${d.event_link?`<button class="link-btn copy-lnk" onclick="copyLnk('${x(d.event_link)}',this)"><i class="fas fa-link"></i> Copy Calendar Link</button>`:''}
          ${d.share_link&&d.share_link!==d.event_link?`<a href="${d.share_link}" target="_blank" class="link-btn secondary"><i class="fas fa-share"></i> Share This Event</a>`:''}
        </div>
        <div class="sc-new" onclick="startNew()">Schedule Another Meeting</div>
      </div>
      <div class="msg-time">${nowStr()}</div>
    </div>`;
  msgs.appendChild(wrap);
  msgs.scrollTop=msgs.scrollHeight;
}

function botMsg(t){addMsg('bot',t);}
function userMsg(t){addMsg('user',t);}
function addMsg(role,text){
  const msgs=ge('messages');
  const div=document.createElement('div');
  div.className=`msg ${role}`;
  div.innerHTML=`
    <div class="msg-av ${role}">${role==='bot'?'A':'U'}</div>
    <div class="msg-body">
      <div class="bubble">${fmt(text)}</div>
      <div class="msg-time">${nowStr()}</div>
    </div>`;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}
function fmt(t){return String(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}
let typEl=null;
function showTyping(){
  if(typEl) return;
  const msgs=ge('messages');
  typEl=document.createElement('div');
  typEl.className='msg bot';
  typEl.innerHTML=`<div class="msg-av bot">A</div><div class="msg-body"><div class="bubble" style="padding:8px 14px"><div class="typing-dots"><span></span><span></span><span></span></div></div></div>`;
  msgs.appendChild(typEl);msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){if(typEl){typEl.remove();typEl=null;}}

function stepForward(){
  if(convStep<STEPS.length){
    if(convStep>0){
      const p=ge(STEPS[convStep-1]);
      if(p){p.classList.remove('active');p.classList.add('done');p.querySelector('.step-dot').textContent='✓';}
    }
    const c=ge(STEPS[convStep]);
    if(c) c.classList.add('active');
    convStep++;
  }
}
function setSteps(n){
  STEPS.forEach((id,i)=>{
    const el=ge(id);if(!el) return;
    el.classList.remove('active','done');
    if(i<n-1){el.classList.add('done');el.querySelector('.step-dot').textContent='✓';}
    else if(i===n-1) el.classList.add('active');
  });
  convStep=n;
}

async function loadRecent(){
  try{
    const list=await api('/api/bookings');
    const el=ge('recent-list');
    if(!list.length){el.innerHTML='<div style="font-size:13px;color:var(--muted)">No bookings yet.</div>';return;}
    el.innerHTML=list.slice(0,5).map(b=>{
      const realLink=b.event_link&&b.event_link.startsWith('http')&&!b.event_link.includes('demo_');
      const timeRange=fmtTimeRange(b.start_time, b.end_time);
      return `<div class="booking-item">
        <div class="bi-title">${x(b.title||'Meeting')}</div>
        <div class="bi-meta">${x(b.name)} · ${fmtDate(b.date)}<br>${timeRange}</div>
        ${realLink?`<a href="${b.event_link}" target="_blank" class="bi-link">Open in Calendar →</a>`:''}
      </div>`;
    }).join('');
  }catch(e){}
}

async function startNew(){
  currentBooking=null;pendingCard=null;convStep=0;
  ge('messages').innerHTML='';
  STEPS.forEach((id,i)=>{
    const el=ge(id);if(!el) return;
    el.classList.remove('active','done');
    el.querySelector('.step-dot').textContent=i+1;
  });
  await startConv();
}

async function api(path,method='GET',body=null){
  const opts={method,headers:{'Content-Type':'application/json'}};
  if(body) opts.body=JSON.stringify(body);
  const r=await fetch(path,opts);
  return r.json();
}
function ge(id){return document.getElementById(id);}
function x(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function nowStr(){return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fmtDate(d){
  if(!d) return '';
  try{const dt=new Date(d+'T12:00:00');return dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});}
  catch{return d;}
}
function fmtTimeRange(start, end){
  if(!start||!end) return '';
  try{
    const startDt=new Date('2000-01-01T'+start);
    const endDt=new Date('2000-01-01T'+end);
    const startStr=startDt.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true});
    const endStr=endDt.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true});
    return `${startStr} to ${endStr}`;
  }catch{return `${start} to ${end}`;}
}
function copyLnk(url,btn){
  navigator.clipboard.writeText(url).then(()=>{
    btn.textContent='Copied!';
    setTimeout(()=>btn.innerHTML='<i class="fas fa-link"></i> Copy Calendar Link',2000);
    toast('Link copied to clipboard!');
  });
}
function toast(msg,ms=3200){
  const t=ge('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),ms);
}
</script>
</body>
</html>
